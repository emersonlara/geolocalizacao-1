package com.aplicacao.geolocalizacao.api.util;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.MalformedURLException;
import java.net.URL;
import java.net.URLConnection;

import javax.servlet.http.HttpServletRequest;

import org.codehaus.jackson.map.DeserializationConfig;
import org.springframework.stereotype.Component;

import com.aplicacao.geolocalizacao.api.mapeador.DadosGeolocalizacaoMapper;
import com.aplicacao.geolocalizacao.api.mapeador.GeolocalizacaoMapper;
import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.ObjectMapper;

@Component
public class WebUtils {
	
	
	 

    public static String getClientIp(HttpServletRequest request) {

        String remoteAddr = "";

        if (request != null) {
            remoteAddr = request.getHeader("X-FORWARDED-FOR");
            if (remoteAddr == null || "".equals(remoteAddr)) {
                remoteAddr = request.getRemoteAddr();
            }
        }
        
        geolocalizacao(remoteAddr);
        

        return remoteAddr;
    } 
    
    
    public static void geolocalizacao(String ip) {
    	URL url;
		try {
			url = new URL("https://ipvigilante.com/8.8.8.8");
			URLConnection conecta = url.openConnection();
			BufferedReader buffer = new BufferedReader(new InputStreamReader(conecta.getInputStream()));
			
			String jsonString  = buffer.readLine();
//			String jsonString = "{\"type\":\"champion\",\"version\":\"7.10.1\",\"data\":{\"89\":{\"id\":89,\"key\":\"Leona\",\"name\":\"Leona\",\"title\":\"a Alvorada Radiante\"},\"110\":{\"id\":110,\"key\":\"Varus\",\"name\":\"Varus\",\"title\":\"a Flecha da Vingança\"}}}";
			
			
						
			ObjectMapper mapper = new ObjectMapper();
			mapper.enable(DeserializationFeature.ACCEPT_EMPTY_STRING_AS_NULL_OBJECT);
//			mapper.configure(DeserializationConfig.Feature.ACCEPT_EMPTY_STRING_AS_NULL_OBJECT, true)
			
			GeolocalizacaoMapper geolocalizacaoMapper = mapper.readValue(jsonString, GeolocalizacaoMapper.class);
			
//			System.out.println("Tipo: " + geolocalizacaoMapper.getType());
//	        System.out.println("Versão: " + geolocalizacaoMapper.getVersion());
//
//	        System.out.println();
//
//	        System.out.println("Dados do champion:");
//	        System.out.println("---------------");

//	        for (DadosGeolocalizacaoMapper dadosChampion : geolocalizacaoMapper.getData().values()) {
//	            System.out.println("ID: " + dadosChampion.getId());
//	            System.out.println("KEY: " + dadosChampion.getKey());
//	            System.out.println("NOME: " + dadosChampion.getName());
//	            System.out.println("Title: " + dadosChampion.getTitle());
//	            System.out.println("---------------");
//	        }
	        
//	        for(DadosGeolocalizacaoMapper dadosGeolocalizacaoMapper : geolocalizacaoMapper.getData().values()) {
	        	
//	        	System.out.println("ipv4: " + dadosGeolocalizacaoMapper.getIpv4());
//	        	System.out.println("continent_name: " + dadosGeolocalizacaoMapper.getContinent_name() );
//	        	System.out.println("country_name: " + dadosGeolocalizacaoMapper.getCountry_name());
//	        	System.out.println("subdivision_1_name: " + dadosGeolocalizacaoMapper.getSubdivision_1_name());
//	        	System.out.println("subdivision_2_name: " + dadosGeolocalizacaoMapper.getSubdivision_2_name());
//	        	System.out.println("city_name: " + dadosGeolocalizacaoMapper.getCity_name());
//	        	System.out.println("latitude: " + dadosGeolocalizacaoMapper.getLatitude());
//	        	System.out.println("longitude: " + dadosGeolocalizacaoMapper.getLongitude());
	        	
//	        }
			
			
		} catch (MalformedURLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
    	
    	
    	
    }
    
	
}
