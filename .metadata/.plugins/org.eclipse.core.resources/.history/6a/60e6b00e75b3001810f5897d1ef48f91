package com.aplicacao.geolocalizacao.api.util;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.MalformedURLException;
import java.net.URL;
import java.net.URLConnection;
import java.util.ArrayList;

import javax.servlet.http.HttpServletRequest;

import com.aplicacao.geolocalizacao.api.mapeador.GeolocalizacaoMapper;
import com.google.gson.Gson;

public class WebUtils {
	
	public static final String IPVISITANTE = "https://ipvigilante.com/";

    public String getClientIp(HttpServletRequest request) {

        String remoteAddr = "";

        if (request != null) {
            remoteAddr = request.getHeader("X-FORWARDED-FOR");
            if (remoteAddr == null || "".equals(remoteAddr)) {
                remoteAddr = request.getRemoteAddr();
            }
        }
        
        GeolocalizacaoMapper geolocalizacaoMapper =  geolocalizacao(remoteAddr);
        System.out.println("------------- Latitude e Longitude");
        System.out.println(geolocalizacaoMapper.getData().getLatitude());
        System.out.println(geolocalizacaoMapper.getData().getLongitude());
        System.out.println(geolocalizacaoMapper.getData().getSubdivision_1_name());

        return remoteAddr;
    } 
    
    
    public ArrayList<String> geolocalizacao(String ip) {
    	URL url;
    	GeolocalizacaoMapper geolocalizacaoMapper = null;
    	ArrayList<String> geoLocalizacao = new ArrayList<String>();
		try {
//			url = new URL(IPVISITANTE + ip);
			url = new URL(IPVISITANTE + "189.105.87.167");
			URLConnection conecta = url.openConnection();
			BufferedReader buffer = new BufferedReader(new InputStreamReader(conecta.getInputStream()));
			
			String jsonString  = buffer.readLine();
			
			Gson gson = new Gson();
			geolocalizacaoMapper = gson.fromJson(jsonString, GeolocalizacaoMapper.class);
			
			geoLocalizacao.add(geolocalizacaoMapper.getData().getLatitude());
			geoLocalizacao.add(geolocalizacaoMapper.getData().getLongitude());
			geoLocalizacao.add(geolocalizacaoMapper.getData().getSubdivision_1_name());
			
		} catch (MalformedURLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		return geoLocalizacao;
    	
    }
    
	
}
