package com.aplicacao.geolocalizacao.api.util;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.MalformedURLException;
import java.net.URL;
import java.net.URLConnection;
import java.util.ArrayList;
import java.util.Date;

import javax.servlet.http.HttpServletRequest;

import org.springframework.stereotype.Service;

import com.aplicacao.geolocalizacao.api.mapeador.GeolocalizacaoMapper;
import com.aplicacao.geolocalizacao.api.mapeador.GeolocalizadorWoeidMapper;
import com.google.gson.Gson;


public class WebUtils {
	
	public static final String IPVISITANTE = "https://ipvigilante.com/";
	public static final String GEOLOCALIZACAO = "https://www.metaweather.com/api/location/search/?lattlong=";

    public static String getClientIp(HttpServletRequest request) {

        String remoteAddr = "";

        if (request != null) {
            remoteAddr = request.getHeader("X-FORWARDED-FOR");
            if (remoteAddr == null || "".equals(remoteAddr)) {
                remoteAddr = request.getRemoteAddr();
            }
        }
        
//        GeolocalizacaoMapper geolocalizacaoMapper =  geolocalizacao(remoteAddr);
//        System.out.println("------------- Latitude e Longitude");
//        System.out.println(geolocalizacaoMapper.getData().getLatitude());
//        System.out.println(geolocalizacaoMapper.getData().getLongitude());
//        System.out.println(geolocalizacaoMapper.getData().getSubdivision_1_name());

        return remoteAddr;
    } 
    
    
    public static ArrayList<String> geolocalizacao(String ip) {
    	URL url;
    	GeolocalizacaoMapper geolocalizacaoMapper = null;
    	ArrayList<String> geoLocalizacao = new ArrayList<String>();
		try {
//			url = new URL(IPVISITANTE + ip);
			url = new URL(IPVISITANTE + "189.105.87.167");
			URLConnection conecta = url.openConnection();
			BufferedReader buffer = new BufferedReader(new InputStreamReader(conecta.getInputStream()));
			
			String jsonString  = buffer.readLine();
			
			Gson gson = new Gson();
			geolocalizacaoMapper = gson.fromJson(jsonString, GeolocalizacaoMapper.class);
			
			geoLocalizacao.add(geolocalizacaoMapper.getData().getLatitude());
			geoLocalizacao.add(geolocalizacaoMapper.getData().getLongitude());
			geoLocalizacao.add(geolocalizacaoMapper.getData().getSubdivision_1_name());
			geoLocalizacao.add(geolocalizacaoMapper.getData().getCity_name());
			
		} catch (MalformedURLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		return geoLocalizacao;
    	
    }


	public static ArrayList<String> temperaturaLocal(ArrayList<String> geoLocalizacao) {
		
		String latitude = geoLocalizacao.get(0);
		String longitude = geoLocalizacao.get(1) ;
		String subdivision_1_name = geoLocalizacao.get(2);
		String city_name = geoLocalizacao.get(3);
		
		URL url;
		GeolocalizadorWoeidMapper goGeolocalizadorWoeidMapper = null;
		
		try {
			url = new URL(GEOLOCALIZACAO + latitude+','+longitude);
			URLConnection conecta = url.openConnection();
			BufferedReader buffer = new BufferedReader(new InputStreamReader(conecta.getInputStream()));
			
			String jsonString  = buffer.readLine();
			
			Gson gson = new Gson();
			goGeolocalizadorWoeidMapper = gson.fromJson(jsonString, GeolocalizadorWoeidMapper.class);
			
		} catch (MalformedURLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
			
		return null;
	}
    
	
}
